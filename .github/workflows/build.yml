name: Cross-Platform Build

on:
  pull_request:
    branches:
      - simbo1905
      - main
  push:
    branches:
      - simbo1905
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch, tag, or commit SHA to build'
        required: false
        default: ''
        type: string

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Debian Trixie (testing)
          - os: ubuntu-latest
            name: Debian Trixie
            container: debian:trixie
            cmake_args: '-DLUNET_DB_DRIVER=sqlite'
            
          # macOS (Apple Silicon / Intel)
          - os: macos-latest
            name: macOS
            container: ''
            cmake_args: '-DLUNET_DB_DRIVER=sqlite'
            
          # Windows 11 (latest Windows runner)
          - os: windows-latest
            name: Windows 11
            container: ''
            cmake_args: '-DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DLUNET_DB_DRIVER=sqlite'

    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container || null }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      # =======================================================================
      # Debian Trixie Setup
      # =======================================================================
      - name: Install dependencies (Debian)
        if: matrix.container == 'debian:trixie'
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            luajit \
            libluajit-5.1-dev \
            libuv1-dev \
            curl \
            lsof \
            procps \
            git

      - name: Configure CMake (Debian)
        if: matrix.container == 'debian:trixie'
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DLUNET_ENABLE_MYSQL=OFF \
            ${{ matrix.cmake_args }}

      - name: Build (Debian)
        if: matrix.container == 'debian:trixie'
        run: cmake --build build --config Release -j$(nproc)

      - name: Verify binary (Debian)
        if: matrix.container == 'debian:trixie'
        run: |
          ls -la build/lunet
          file build/lunet

      - name: Run integration tests (Debian)
        if: matrix.container == 'debian:trixie'
        run: |
          # Create temp directory for SQLite database
          mkdir -p .tmp
          
          # Start server in background
          echo "Starting server..."
          ./build/lunet app/main.lua &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server to be ready
          echo "Waiting for server to be ready..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:8080/api/tags > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Server process died!"
              exit 1
            fi
            sleep 1
          done
          
          # Run integration tests
          echo "Running integration tests..."
          chmod +x bin/test_api.sh
          ./bin/test_api.sh
          TEST_EXIT=$?
          
          # Stop server
          echo "Stopping server..."
          kill $SERVER_PID 2>/dev/null || true
          
          exit $TEST_EXIT

      # =======================================================================
      # macOS Setup
      # =======================================================================
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install luajit libuv

      - name: Configure CMake (macOS)
        if: runner.os == 'macOS'
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DLUNET_ENABLE_MYSQL=OFF \
            ${{ matrix.cmake_args }}

      - name: Build (macOS)
        if: runner.os == 'macOS'
        run: cmake --build build --config Release -j$(sysctl -n hw.ncpu)

      - name: Verify binary (macOS)
        if: runner.os == 'macOS'
        run: |
          ls -la build/lunet
          file build/lunet

      - name: Run integration tests (macOS)
        if: runner.os == 'macOS'
        run: |
          # Create temp directory for SQLite database
          mkdir -p .tmp
          
          # Start server in background
          echo "Starting server..."
          ./build/lunet app/main.lua &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server to be ready
          echo "Waiting for server to be ready..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:8080/api/tags > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Server process died!"
              exit 1
            fi
            sleep 1
          done
          
          # Run integration tests
          echo "Running integration tests..."
          chmod +x bin/test_api.sh
          ./bin/test_api.sh
          TEST_EXIT=$?
          
          # Stop server
          echo "Stopping server..."
          kill $SERVER_PID 2>/dev/null || true
          
          exit $TEST_EXIT

      # =======================================================================
      # Windows Setup
      # =======================================================================
      - name: Setup vcpkg cache (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: C:/vcpkg/installed
          key: vcpkg-windows-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            vcpkg-windows-

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          vcpkg install luajit:x64-windows libuv:x64-windows
        shell: cmd

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        run: |
          cmake -B build ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DLUNET_ENABLE_MYSQL=OFF ^
            ${{ matrix.cmake_args }}
        shell: cmd

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: cmake --build build --config Release
        shell: cmd

      - name: Verify binary (Windows)
        if: runner.os == 'Windows'
        run: |
          dir build\Release\
        shell: cmd

      - name: Run integration tests (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Create temp directory for SQLite database
          if (-not (Test-Path ".tmp")) {
              New-Item -ItemType Directory -Path ".tmp" | Out-Null
          }
          
          # Start server in background
          Write-Host "Starting server..."
          $process = Start-Process -FilePath "build\Release\lunet.exe" -ArgumentList "app/main.lua" -PassThru -NoNewWindow
          Write-Host "Server PID: $($process.Id)"
          
          # Wait for server to be ready
          Write-Host "Waiting for server to be ready..."
          $ready = $false
          for ($i = 0; $i -lt 30; $i++) {
              try {
                  $response = Invoke-WebRequest -Uri "http://localhost:8080/api/tags" -UseBasicParsing -TimeoutSec 2 -ErrorAction SilentlyContinue
                  if ($response.StatusCode -eq 200) {
                      Write-Host "Server is ready!"
                      $ready = $true
                      break
                  }
              } catch {
                  # Server not ready yet
              }
              if ($process.HasExited) {
                  Write-Host "Server process died!"
                  exit 1
              }
              Start-Sleep -Seconds 1
          }
          
          if (-not $ready) {
              Write-Host "Server did not become ready in time"
              Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
              exit 1
          }
          
          # Run integration tests
          Write-Host "Running integration tests..."
          $testsPassed = 0
          $testsFailed = 0
          
          # Test 1: GET /api/tags
          Write-Host "[TEST] GET /api/tags"
          try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080/api/tags" -UseBasicParsing
              if ($response.StatusCode -eq 200 -and $response.Content -match "tags") {
                  Write-Host "[PASS] GET /api/tags returns 200"
                  $testsPassed++
              } else {
                  Write-Host "[FAIL] GET /api/tags"
                  $testsFailed++
              }
          } catch {
              Write-Host "[FAIL] GET /api/tags: $_"
              $testsFailed++
          }
          
          # Test 2: GET /api/articles
          Write-Host "[TEST] GET /api/articles"
          try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080/api/articles" -UseBasicParsing
              if ($response.StatusCode -eq 200 -and $response.Content -match "articlesCount") {
                  Write-Host "[PASS] GET /api/articles returns 200"
                  $testsPassed++
              } else {
                  Write-Host "[FAIL] GET /api/articles"
                  $testsFailed++
              }
          } catch {
              Write-Host "[FAIL] GET /api/articles: $_"
              $testsFailed++
          }
          
          # Test 3: POST /api/users (register)
          Write-Host "[TEST] POST /api/users (register)"
          $testUser = "apitest_$([DateTimeOffset]::Now.ToUnixTimeSeconds())"
          $body = @{
              user = @{
                  username = $testUser
                  email = "$testUser@example.com"
                  password = "password123"
              }
          } | ConvertTo-Json
          try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080/api/users" -Method POST -Body $body -ContentType "application/json" -UseBasicParsing
              if ($response.StatusCode -eq 201 -and $response.Content -match "token") {
                  Write-Host "[PASS] POST /api/users returns 201"
                  $testsPassed++
                  
                  # Extract token
                  $json = $response.Content | ConvertFrom-Json
                  $token = $json.user.token
                  
                  # Test 4: GET /api/user (authenticated)
                  Write-Host "[TEST] GET /api/user (authenticated)"
                  try {
                      $headers = @{ "Authorization" = "Token $token" }
                      $response = Invoke-WebRequest -Uri "http://localhost:8080/api/user" -Headers $headers -UseBasicParsing
                      if ($response.StatusCode -eq 200 -and $response.Content -match $testUser) {
                          Write-Host "[PASS] GET /api/user returns 200"
                          $testsPassed++
                      } else {
                          Write-Host "[FAIL] GET /api/user"
                          $testsFailed++
                      }
                  } catch {
                      Write-Host "[FAIL] GET /api/user: $_"
                      $testsFailed++
                  }
                  
                  # Test 5: POST /api/articles (create)
                  Write-Host "[TEST] POST /api/articles (create)"
                  $articleBody = @{
                      article = @{
                          title = "Test Article $([DateTimeOffset]::Now.ToUnixTimeSeconds())"
                          description = "Test description"
                          body = "Test body content"
                          tagList = @("test", "api")
                      }
                  } | ConvertTo-Json
                  try {
                      $headers = @{ "Authorization" = "Token $token" }
                      $response = Invoke-WebRequest -Uri "http://localhost:8080/api/articles" -Method POST -Body $articleBody -ContentType "application/json" -Headers $headers -UseBasicParsing
                      if ($response.StatusCode -eq 201 -and $response.Content -match "slug") {
                          Write-Host "[PASS] POST /api/articles returns 201"
                          $testsPassed++
                      } else {
                          Write-Host "[FAIL] POST /api/articles"
                          $testsFailed++
                      }
                  } catch {
                      Write-Host "[FAIL] POST /api/articles: $_"
                      $testsFailed++
                  }
              } else {
                  Write-Host "[FAIL] POST /api/users"
                  $testsFailed++
              }
          } catch {
              Write-Host "[FAIL] POST /api/users: $_"
              $testsFailed++
          }
          
          # Test 6: Unauthenticated article create should fail
          Write-Host "[TEST] POST /api/articles without auth should return 401"
          $articleBody = @{
              article = @{
                  title = "Should Fail"
                  description = "No auth"
                  body = "test"
              }
          } | ConvertTo-Json
          try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080/api/articles" -Method POST -Body $articleBody -ContentType "application/json" -UseBasicParsing -ErrorAction SilentlyContinue
              Write-Host "[FAIL] POST /api/articles without auth should have failed"
              $testsFailed++
          } catch {
              if ($_.Exception.Response.StatusCode -eq 401) {
                  Write-Host "[PASS] POST /api/articles without auth returns 401"
                  $testsPassed++
              } else {
                  Write-Host "[FAIL] POST /api/articles without auth: unexpected status"
                  $testsFailed++
              }
          }
          
          # Stop server
          Write-Host "Stopping server..."
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          
          # Summary
          Write-Host ""
          Write-Host "==================================="
          Write-Host "RESULTS: $testsPassed passed, $testsFailed failed"
          Write-Host "==================================="
          
          if ($testsFailed -gt 0) {
              exit 1
          }

      # =======================================================================
      # Upload Artifacts
      # =======================================================================
      - name: Upload binary artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: lunet-${{ matrix.name }}
          path: build/lunet
          if-no-files-found: error

      - name: Upload binary artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: lunet-${{ matrix.name }}
          path: build/Release/lunet.exe
          if-no-files-found: error
