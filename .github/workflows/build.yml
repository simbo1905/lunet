name: Build

on:
  push:
    branches: [ simbo1905, windows11, windows, main, xmake ]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  pull_request:
    branches: [ simbo1905, main ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to build'
        required: false
        default: ''

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          vcpkg/installed
          vcpkg/packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('xmake.lua') }}-${{ hashFiles('vcpkg.json', 'ports/*/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    # Install xmake
    - uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest

    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libuv1-dev luajit libluajit-5.1-dev

    - name: Install Dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install pkg-config libuv luajit

    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '66c0373dc7fca549e5803087b9487edfe3aca0a1'
      env:
        VCPKG_BINARY_SOURCES: 'clear;nuget,readwrite'

    - name: Install Dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        vcpkg install libuv:x64-windows
        vcpkg install luajit:x64-windows
        vcpkg install libpq:x64-windows --feature lz4
        vcpkg install libpq:x64-windows --feature openssl
        vcpkg install libpq:x64-windows --feature zlib

    - name: Configure (Unix)
      if: runner.os != 'Windows'
      run: xmake f -m release -y

    - name: Configure (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        $env:CL = "/MP"  # Multi-processor compilation
        $env:CI = "true"
        xmake f -m release -y

    - name: Build Core
      run: xmake build
    
    - name: Build SQLite3 Driver
      run: xmake build lunet-sqlite3

    - name: Test (Proof of Life - Unix)
      if: runner.os != 'Windows'
      run: |
        echo "print('LuaJIT initialized:', jit.version)" > test.lua
        # Find the binary (lunet-run is the CLI, lunet.so is the module)
        LUNET_BIN=$(find build -name 'lunet-run' -type f | head -1)
        echo "Found binary: $LUNET_BIN"
        $LUNET_BIN test.lua

    - name: Test (Module Load - Unix)
      if: runner.os != 'Windows'
      run: |
        LUNET_BIN=$(find build -name 'lunet-run' -type f | head -1)
        LUNET_SO=$(find build -name 'lunet.so' -type f | head -1)
        if [ -z "$LUNET_BIN" ] || [ -z "$LUNET_SO" ]; then
          echo "Error: build outputs not found" >&2
          exit 1
        fi
        MOD_DIR=$(dirname "$LUNET_SO")
        cat > test_module.lua <<'EOF'
        package.cpath = os.getenv("LUNET_CPATH") .. ";" .. package.cpath
        local lunet = require("lunet")
        assert(type(lunet.spawn) == "function")
        print("lunet module loaded")
        EOF
        LUNET_CPATH="$MOD_DIR/?.so" $LUNET_BIN test_module.lua

    - name: SQLite3 Smoke Test (Unix)
      if: runner.os != 'Windows'
      run: |
        LUNET_BIN=$(find build -name 'lunet-run' -type f | head -1)
        echo "Running SQLite3 smoke test..."
        $LUNET_BIN test/smoke_sqlite3.lua

    - name: Test (Proof of Life - Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        "print('LuaJIT initialized:', jit.version)" | Out-File -FilePath test.lua -Encoding utf8
        $lunet = Get-ChildItem -Path build -Recurse -Filter "lunet-run.exe" | Select-Object -First 1
        & $lunet.FullName test.lua

    - name: Test (Module Load - Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $lunet = Get-ChildItem -Path build -Recurse -Filter "lunet-run.exe" | Select-Object -First 1
        $mod  = Get-ChildItem -Path build -Recurse -Filter "lunet.dll" | Select-Object -First 1
        if (-not $lunet) { throw "lunet-run.exe not found" }
        if (-not $mod) { throw "lunet.dll not found" }
        $modDir = $mod.Directory.FullName
        @"
        package.cpath = os.getenv('LUNET_CPATH') .. ';' .. package.cpath
        local lunet = require('lunet')
        assert(type(lunet.spawn) == 'function')
        print('lunet module loaded')
        "@ | Out-File -FilePath test_module.lua -Encoding utf8
        $env:LUNET_CPATH = "$modDir\\?.dll"
        & $lunet.FullName test_module.lua

    - name: SQLite3 Smoke Test (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $lunet = Get-ChildItem -Path build -Recurse -Filter "lunet-run.exe" | Select-Object -First 1
        Write-Host "Running SQLite3 smoke test..."
        & $lunet.FullName test/smoke_sqlite3.lua

    - name: Upload artifact (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: lunet-linux-amd64
        path: |
          build/**/lunet-run
          build/**/lunet.so
          build/**/lunet/*.so

    - name: Upload artifact (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: lunet-macos
        path: |
          build/**/lunet-run
          build/**/lunet.so
          build/**/lunet/*.so

    - name: Upload artifact (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: lunet-windows-amd64
        path: |
          build/**/lunet-run.exe
          build/**/lunet.dll
          build/**/lunet/*.dll

  release:
    name: Upload Release Binaries
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package Linux
        run: |
          cd artifacts/lunet-linux-amd64
          tar -czvf ../lunet-linux-amd64.tar.gz .

      - name: Package macOS
        run: |
          cd artifacts/lunet-macos
          tar -czvf ../lunet-macos.tar.gz .

      - name: Package Windows
        run: |
          cd artifacts/lunet-windows-amd64
          zip -r ../lunet-windows-amd64.zip .

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/lunet-linux-amd64.tar.gz
            artifacts/lunet-macos.tar.gz
            artifacts/lunet-windows-amd64.zip
