name: Build

on:
  push:
    branches: [ main, xmake ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to build'
        required: false
        default: ''

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          vcpkg/installed
          vcpkg/packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('xmake.lua') }}-${{ hashFiles('vcpkg.json', 'ports/*/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: Install xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest

    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libuv1-dev luajit libluajit-5.1-dev

    - name: Install Dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install pkg-config libuv luajit

    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '66c0373dc7fca549e5803087b9487edfe3aca0a1'
        vcpkgDirectory: D:\a\lunet\lunet\vcpkg
        runVcpkgInstall: false
        vcpkgGitURL: https://github.com/microsoft/vcpkg.git
        doNotUpdateVcpkg: false
        doNotCache: true
        vcpkgJsonGlob: **/vcpkg.json
        vcpkgJsonIgnores: ['**/vcpkg/**']
        vcpkgConfigurationJsonGlob: **/vcpkg-configuration.json
        runVcpkgFormatString: ['install', '--recurse', '--clean-after-build', '--x-install-root', '$\u005benv.VCPKG_INSTALLED_DIR\u005d', '--triplet', '$\u005benv.VCPKG_DEFAULT_TRIPLET\u005d']
        useShell: true
        logCollectionRegExps: \s*'(.+CMakeOutput\.log)'\.\s*;\s*'(.+CMakeError\.log)'\.\s*;\s*(.+)out\.log\s*;\s+(.+)err\.log\s*;\s*(.+vcpkg.+\.log)\s*
      env:
        VCPKG_BINARY_SOURCES: 'clear;nuget,readwrite'
        VCPKG_RETRY_COUNT: '3'
        VCPKG_RETRY_DELAY: '2'
        VCPKG_USE_HEAD_VERSION: 'false'
        VCPKG_CMAKE_VERSION: '3.31.10'
        VCPKG_DISABLE_METRICS: 'true'

    - name: Install Dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        vcpkg install libuv:x64-windows
        vcpkg install luajit:x64-windows
        vcpkg install libpq[lz4,openssl,zlib]:x64-windows

    - name: Configure (Unix)
      if: runner.os != 'Windows'
      run: |
        xmake f -m release -y -C

    - name: Configure (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        $env:CL = "/MP"  # Multi-processor compilation
        $env:CI = "true"
        xmake f -m release -y -C

    - name: Build
      run: |
        xmake build

    - name: Upload artifact (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: lunet-linux-amd64
        path: |
          build/**/lunet-run
          build/**/lunet.so
          build/**/lunet/*.so

    - name: Upload artifact (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: lunet-macos
        path: |
          build/**/lunet-run
          build/**/lunet.so
          build/**/lunet/*.so

    - name: Upload artifact (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: lunet-windows-amd64
        path: |
          build/**/lunet-run.exe
          build/**/lunet.dll
          build/**/lunet/*.dll