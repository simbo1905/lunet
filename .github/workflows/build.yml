name: Build

on:
  push:
    branches: [ simbo1905, windows11, cursor/fix-ci-macos-windows ]
  pull_request:
    branches: [ simbo1905 ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to build'
        required: false
        default: ''

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest] # macos-latest disabled for now

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.ref || github.ref }}

    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libuv1-dev libsodium-dev sqlite3 libsqlite3-dev postgresql-client libpq-dev luajit libluajit-5.1-dev luarocks
        sudo luarocks install busted

    # macOS disabled
    # - name: Install Dependencies (macOS)
    #   if: runner.os == 'macOS'
    #   run: |
    #     brew install cmake libuv libsodium sqlite libpq luajit luarocks
    #     luarocks install busted
    #     # Link libpq to make it findable by CMake
    #     brew link --force libpq

    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      uses: lukka/run-vcpkg@v11
      # Using default options to get latest vcpkg

    - name: Install Dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        vcpkg install libuv:x64-windows libsodium:x64-windows sqlite3:x64-windows libpq:x64-windows luajit:x64-windows

    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "VCPKG_ROOT: $env:VCPKG_ROOT"
        cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/cmake/vcpkg.cmake" -DCMAKE_BUILD_TYPE=Release

    - name: Configure CMake (Unix)
      if: runner.os != 'Windows'
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Test (Proof of Life)
      shell: bash
      run: |
        echo "print('âœ“ LuaJIT initialized')" > test.lua
        if [ "$RUNNER_OS" == "Windows" ]; then
          ./build/Release/lunet.exe test.lua
        else
          ./build/lunet test.lua
        fi

    - name: Unit Tests (Unix)
      if: runner.os != 'Windows'
      run: busted spec/

    - name: Integration Test (API)
      shell: bash
      run: |
        # Start server in background
        if [ "$RUNNER_OS" == "Windows" ]; then
          # Use powershell to run the ps1 script from bash
          powershell -ExecutionPolicy Bypass -File bin/start_server.ps1 app/main.lua
        else
          ./bin/start_server.sh app/main.lua
        fi
        
        # Run API tests
        ./bin/test_api.sh
        
        # Stop server
        if [ "$RUNNER_OS" == "Windows" ]; then
          powershell -ExecutionPolicy Bypass -File bin/stop_server.ps1
        else
          ./bin/stop_server.sh
        fi
