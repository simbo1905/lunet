# Nginx config for Lunet RealWorld benchmark
# Usage: nginx -p $GIT_ROOT -c bench/lunet/nginx.conf
# Serves frontend on port 8081 and proxies /api to Lunet on 8080
#
# Note: Logs go to .tmp/ directory (gitignored)

error_log .tmp/lunet_nginx_error.log info;

events {
    worker_connections 64;
}

http {
    # Portable mime types
    include mime.types;
    default_type application/octet-stream;
    access_log .tmp/lunet_nginx_access.log;

    server {
        listen 8081;
        server_name _;  # Catch-all server name

        root bench/lunet;

        # Serve the single-page frontend (SPA routing)
        location = / {
            try_files /conduit.html =404;
        }
        
        location = /conduit.html {
            try_files /conduit.html =404;
        }

        # For SPA deep linking if we were serving built assets, 
        # but here we just serve conduit.html for the root.
        # If the user tries http://localhost:8081/article/slug, it should serve conduit.html
        # We need to add a catch-all for non-API, non-asset paths if we want true SPA behavior.
        # But conduit.html is a single file. Let's make it work for paths.
        
        # Generic fallback for SPA routes (everything that isn't /api or an existing file)
        location / {
            try_files $uri /conduit.html;
        }

        # Proxy API requests to Lunet backend
        location /api/ {
            proxy_pass http://127.0.0.1:8080/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Proxy timeouts and settings
            proxy_read_timeout 60s;
            proxy_connect_timeout 60s;
            proxy_buffering off;
        }
    }
}
